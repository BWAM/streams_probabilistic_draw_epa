---
title: "2023-2027_epa_draw"
author: "Keleigh Reynolds"
date: "1/20/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 2023 - 2027 EPA Probabilistic Draw

```{r begin-draw}
library(spsurvey)
citation("spsurvey")

```

```{r begin-GRTS}
set.seed(51) #set seed for analysis

```

we are going to run it with unequal inclusion probability; stratified by basin

# from previous draws

Sample Frame: Sample frame used is the National Rivers and Streams Assessment sample frame for 2013-14 survey (indicated by FRAME14 attribute in NRSA sample frame.  The New York basins were added as an attribute based on GIS coverage provided by New York.  Only segments that were “Included” in FRAME14 are used in the survey design

Survey Design: A Generalized Random Tessellation Stratified (GRTS) survey design for a linear resource was used.  The GRTS design includes reverse hierarchical ordering of the selected sites.

Multi-density categories:  Rivers are selected with unequal probability by stream order category: 1st, 2nd, 3rd, and 4th+ strahler orders.

Also used : 
"The coordinate reference system (CRS) for the sample frame should use an area-preserving projection such as Albers or UTM so that spatial distances are equivalent for all directions. Geographic CRS are not accepted." converted to UTM


```{r get-backround-files}

# example<-spsurvey::NE_Lakes
# prev_output<-read.csv("C:/Users/kareynol/New York State Office of Information Technology Services/SMAS - Site Selection/Probabilistic_epa_draw_data/Probabilistic/2018_2022Draw/2018_prob_draw.csv")

 basin_path <- here::here("data/map_files") #for keleigh
 basin <- rgdal::readOGR(
   dsn = basin_path,
   layer = "NHD_plus_2_basin",
   verbose = FALSE
 )

# # change coords to UTM for better resolution? as per spsurvey
basin_shp <- sp::spTransform(
  basin,
  sp::CRS("+proj=utm +zone=10 +datum=WGS84"))

raw<-read.csv(here::here("data/NHD_plus_basin.csv"))
# 
short<-raw %>% 
  dplyr::select(1:16,38:40,48,49,131:146)


```

A character vector indicating the expected sample size for each level of caty_var, the unequal probability variable.  If the sampling design is stratified and the expected sample sizes are the same among strata, caty_n is a named vector whose names represent each level of caty_var and whose values represent each level's expected sample size -- these expected sample sizes are applied to all strata. The sum of caty_n must equal each stratum's value in n_base. If the sampling design is stratified and the expected sample sizes differ among strata, caty_n is a list where each element is named as a stratum in n_base. Each stratum's list element is a named vector whose names represent each level of caty_var and whose values represent each level's expected sample size (within the stratum). The sum of the values in each stratum's list element must equal that stratum's value in n_base.


So we'll make a proportional analysis based on the basins, and then figure out how to get 10 sites from that proportion. make the list from the dataframe, and not the one listed in 2018.


```{r}
basin_sf<-sf::st_as_sf(basin_shp)
basin_sf<-basin_sf %>% 
  dplyr::mutate(fcode=as.numeric(FCODE)) %>% 
  dplyr::filter(fcode != 33600,
                  fcode != 33601,
                  fcode != 33603,
                  fcode != 42000,
                  fcode != 42001,
                  fcode != 42002,
                  fcode != 42003,
                  fcode != 56600) %>% 
  dplyr::filter(!dplyr::between(fcode,42800,42824)) %>% 
  dplyr::mutate(stream_order = as.numeric(StreamOrde)) %>% 
  dplyr::mutate(stream_order = dplyr::case_when(
    stream_order >= 4~4,
    TRUE ~ stream_order
  )) %>% 
  dplyr::filter(stream_order != 0)

basin_sf<-basin_sf %>% 
  dplyr::filter(!is.na(M_BAS_NAME))

li<-basin_sf %>% 
  filter(M_BAS_NAME=="Atlantic Ocean-Long Island Sound") %>% 
  filter(row_number()==1) %>% 
  mutate(stream_order=4)

basin_sf<-rbind(basin_sf,li)
  #its probaby because it's missing streamorder4?


basin_sf<-sf::st_as_sf(basin_sf)



```



```{r using-epa-notes}
## set strata variable
stratum_var <- "M_BAS_NAME"

## set caty variable
caty_var <- "stream_order"
## set caty sample sizes
basin_sf$stream_order<-as.character(basin_sf$stream_order)

caty_n2 <- lapply(1:17, function(x) c("1" = 3, "2" = 3, "3" = 2, "4" = 2))
names(caty_n2) <- unique(basin_sf$M_BAS_NAME)
caty_n2


### n1
samp_n1 <- spsurvey::grts(
  basin_sf,
  n_base = 10,
  n_over = 40,
  stratum_var = "M_BAS_NAME",
  caty_n = caty_n2,
  caty_var = "stream_order"
)
### look at caty_n structure
samp_n1$design$caty_n

samp_try <- spsurvey::grts(
  basin_sf,
  n_base = 10,
  n_over = 40)


```

```{r}
#troubleshoot
basin_sum<-as.data.frame(basin_sf)

basin_sum<-basin_sum %>% 
  select(stream_order,M_BAS_NAME) %>% 
  group_by(M_BAS_NAME,stream_order) %>% 
  summarise(n=n())
```

